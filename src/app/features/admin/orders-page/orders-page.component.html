<div class="page-header">
  <div>
    <h1 class="page-title">Orders</h1>
    <p class="page-subtitle">Track purchases, payment status, and customer details.</p>
  </div>
</div>

<div class="filters-section">
  <form [formGroup]="filtersForm" (ngSubmit)="applyFilters()">
    <div class="filters-grid">
      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status">
          <mat-option value="">All statuses</mat-option>
          <mat-option *ngFor="let status of statusOptions" [value]="status">
            {{ formatStatus(status) }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" placeholder="Search by email" />
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Customer Name</mat-label>
        <input matInput formControlName="customerName" placeholder="Search by customer name" />
        <mat-icon matPrefix>person</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Start date</mat-label>
        <input matInput type="date" formControlName="startDate" />
        <mat-icon matPrefix>calendar_today</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>End date</mat-label>
        <input matInput type="date" formControlName="endDate" />
        <mat-icon matPrefix>calendar_today</mat-icon>
      </mat-form-field>
    </div>
    <button mat-raised-button color="primary" type="submit">
      <mat-icon>filter_list</mat-icon>
      Apply filters
    </button>
  </form>
</div>

<div *ngIf="loading(); else tableContent" class="loading-container">
  <app-skeleton height="400px" />
</div>

<ng-template #tableContent>
  <div class="table-container">
    <div class="table-toolbar" *ngIf="orders().length > 0">
      <span class="toolbar-selection" *ngIf="getSelectedCount() > 0">
        {{ getSelectedCount() }} selected
      </span>
      <div class="toolbar-actions">
        <button
          mat-stroked-button
          color="warn"
          (click)="deleteSelectedOrders()"
          [disabled]="getSelectedCount() === 0"
          [attr.aria-label]="'Delete ' + getSelectedCount() + ' selected orders'"
        >
          <mat-icon>delete_sweep</mat-icon>
          Delete selected ({{ getSelectedCount() }})
        </button>
        <button
          mat-stroked-button
          color="warn"
          (click)="emptyAllOrders()"
          [attr.aria-label]="'Delete all ' + orders().length + ' orders'"
        >
          <mat-icon>delete_forever</mat-icon>
          Empty all orders
        </button>
      </div>
    </div>
    <p class="form-error" *ngIf="error()">{{ error() }}</p>
    <table mat-table [dataSource]="dataSource" matSort class="orders-table">
      <!-- Select Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            [checked]="isAllOnPageSelected()"
            [indeterminate]="isSomeOnPageSelected() && !isAllOnPageSelected()"
            (change)="toggleSelectAllOnPage()"
            aria-label="Select all orders on this page"
          ></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let order">
          <mat-checkbox
            [checked]="isOrderSelected(order.id)"
            (change)="toggleOrderSelection(order.id)"
            (click)="$event.stopPropagation()"
            aria-label="Select order for {{ order.full_name }}"
          ></mat-checkbox>
        </td>
      </ng-container>

      <!-- Date Column -->
      <ng-container matColumnDef="created_at">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
        <td mat-cell *matCellDef="let order">
          {{ order.created_at | date: 'mediumDate' }}
        </td>
      </ng-container>

      <!-- Customer Column -->
      <ng-container matColumnDef="full_name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Customer</th>
        <td mat-cell *matCellDef="let order">
          <span class="customer-cell">
            {{ order.full_name }}
            @if (isNewOrder(order.created_at)) {
              <mat-icon
                class="new-order-icon"
                [matTooltip]="'New order â€“ ' + (order.created_at | timeAgo)"
                matTooltipPosition="above"
                aria-hidden="true"
              >fiber_new</mat-icon>
            }
          </span>
        </td>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
        <td mat-cell *matCellDef="let order">{{ order.email }}</td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let order">
          <mat-chip [class]="getStatusClass(order.status)">
            {{ formatStatus(order.status) }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Total Column -->
      <ng-container matColumnDef="total_amount">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Total</th>
        <td mat-cell *matCellDef="let order">
          {{ order.total_amount | currency: order.currency }}
        </td>
      </ng-container>

      <!-- Transaction Column -->
      <ng-container matColumnDef="transaction_id">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Transaction</th>
        <td mat-cell *matCellDef="let order">
          {{ order.transaction_id || 'Pending' }}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let order">
          <span class="actions-cell">
            <button
              mat-icon-button
              matTooltip="View details"
              (click)="selectOrder(order)"
              color="primary"
              [attr.aria-label]="'View details for order ' + order.id"
            >
              <mat-icon>visibility</mat-icon>
            </button>
            <button
              mat-icon-button
              matTooltip="Delete order"
              (click)="deleteOrder(order)"
              color="warn"
              [attr.aria-label]="'Delete order ' + order.id"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </span>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- No data row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="no-data">No orders found</div>
        </td>
      </tr>
    </table>

    <mat-paginator
      [pageSizeOptions]="[5, 10, 25, 50, 100]"
      showFirstLastButtons
      aria-label="Select page of orders"
    ></mat-paginator>
  </div>
</ng-template>
